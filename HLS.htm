<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Custom HLS Player</title>
  <script src="https://cdn.jsdelivr.net/npm/hls.js@0.14.17"></script>
  <style>
    body { margin:0; background:#000; width:100vw; height:100vh; display:flex; flex-direction:column; }
    video { flex:1; width:100%; height:100%; object-fit:contain; }
    #subtitleOverlay {
      position: fixed; z-index: 9999; pointer-events: none;
      display: none; opacity: 0;
      transition: opacity 0.4s ease, transform 0.3s ease;
      max-width: 60%; max-height: 25%;
      left: 50%; bottom: 8%; transform: translateX(-50%);
      filter: drop-shadow(0 2px 4px rgba(0,0,0,0.7));
      border-radius: 6px; background-color: rgba(0,0,0,0.2);
    }
    #controls { background:#111; color:#fff; padding:10px; display:flex; gap:20px; justify-content:center; }
    select { padding:6px; background:rgba(255,255,255,0.1); border:1px solid rgba(255,255,255,0.3); color:#fff; border-radius:4px; }
    #videoTitle { color:#fff; padding:10px; text-align:center; }
    #selectorBar { background:#222; color:#fff; padding:10px; display:none; gap:20px; justify-content:center; }
  </style>
</head>
<body>
  <video id="video" autoplay controls crossorigin="anonymous"></video>
  <img id="subtitleOverlay" />
  <div id="controls">
    <label>Audio: <select id="audioSelector"></select></label>
    <label>Quality: <select id="qualitySelector"></select></label>
    <label>Subtitle: <select id="subtitleSelector"><option value="none">No Subtitles</option></select></label>
  </div>
  <div id="selectorBar">
    <label>Season: <select id="seasonSelect"></select></label>
    <label>Episode: <select id="episodeSelect"></select></label>
  </div>
  <div id="videoTitle"></div>

<!-- Script Part 1: Utilities + Parsers + Subtitle Handling -->
<script>
// --- Utilities ---
async function checkSubtitleExists(url){ try{ const res=await fetch(url,{method:"HEAD"}); return res.ok; }catch{ return false; } }
function extractAudioTracks(m3uText){ const tracks=[]; const regex=/#EXT-X-MEDIA:TYPE=AUDIO.*?LANGUAGE="(.*?)".*?NAME="(.*?)".*?URI="(.*?)"/g; let match;
  while((match=regex.exec(m3uText))!==null){ tracks.push({lang:match[1],name:match[2],uri:match[3]}); } return tracks; }

// --- BDN Conversion ---
function timecodeToVTT(tc){
  const [hh,mm,ss,ms] = tc.split(/[:.]/).map(Number);
  const total = hh*3600 + mm*60 + ss + (ms||0)/1000;
  const h = String(Math.floor(total/3600)).padStart(2,"0");
  const m = String(Math.floor((total%3600)/60)).padStart(2,"0");
  const s = String(Math.floor(total%60)).padStart(2,"0");
  const msStr = String(Math.floor((total%1)*1000)).padStart(3,"0");
  return `${h}:${m}:${s}.${msStr}`;
}
function convertBDNtoVTT(xmlText){
  const xmlDoc = new DOMParser().parseFromString(xmlText,"application/xml");
  const events = xmlDoc.querySelectorAll("Event");
  let vtt = "WEBVTT\n\n";
  events.forEach((ev,idx)=>{
    const start = timecodeToVTT(ev.getAttribute("InTC"));
    const end = timecodeToVTT(ev.getAttribute("OutTC"));
    const g = ev.querySelector("Graphic");
    if(!g) return;
    const imgName = g.textContent.trim();
    vtt += `${idx+1}\n${start} --> ${end}\n${imgName}\n\n`;
  });
  return vtt;
}
async function loadBDNAsVTT(baseUrl, videoId, cdn, lang){
  const res = await fetch(`${baseUrl}/index.xml`);
  if(!res.ok) return {};
  const xmlText = await res.text();
  const folder = baseUrl.split('/').pop();
  const vttText = convertBDNtoVTT(xmlText);
  const blob = new Blob([vttText], {type:"text/vtt"});
  const vttUrl = URL.createObjectURL(blob);

  const track = document.createElement("track");
  track.kind = "subtitles";
  track.label = lang.toUpperCase();
  track.srclang = lang;
  track.src = vttUrl;
  track.mode = "hidden"; // ✅ ให้ cue โหลดทันที
  video.appendChild(track);

  return {folder};
}

function renderSubtitleMenu(subtitles){
  const video=document.getElementById("video");
  const subtitleSelector=document.getElementById("subtitleSelector");
  subtitleSelector.innerHTML='<option value="none">No Subtitles</option>';
  bdnSubtitles.length=0;

  subtitles.forEach(sub=>{
    const opt=document.createElement("option");
    opt.value=sub.lang;
    opt.text=sub.lang.toUpperCase()+" ("+sub.codec+")";
    subtitleSelector.appendChild(opt);

    if(sub.codec==="VTT"){
      const track=document.createElement("track");
      track.kind="subtitles";
      track.label=sub.lang.toUpperCase();
      track.srclang=sub.lang;
      track.src=sub.src;
      video.appendChild(track);
    }
    if(sub.codec==="BDN"){
      bdnSubtitles.push(sub);
    }
  });

  subtitleSelector.onchange=async()=>{
    const selected=subtitleSelector.value;
    Array.from(video.textTracks).forEach(track=>track.mode="disabled");
    subtitleOverlay.style.display="none";
    subtitleOverlay.style.opacity="0";

    if(selected==="none") return;

    // ถ้าเป็น VTT
    const vttTrack=Array.from(video.textTracks).find(
      t => t.srclang === selected || t.label.toLowerCase() === selected.toLowerCase()
    );
    if(vttTrack){
      vttTrack.mode="showing";
      return;
    }

    // ถ้าเป็น BDN
    const bdnEntry=bdnSubtitles.find(sub=>sub.lang===selected);
    if(bdnEntry){
      const { folder }=await loadBDNAsVTT(
        bdnEntry.src.replace("/index.xml",""),
        bdnEntry.videoId,
        bdnEntry.cdn,
        bdnEntry.lang
      );
      activateBDNOverlay(folder, bdnEntry.videoId, bdnEntry.cdn, bdnEntry.lang);
    }
  };
}

function activateBDNOverlay(folder,videoId,cdn,lang){
  const track=Array.from(video.textTracks).find(t=>t.srclang===lang);
  if(!track) return;

  video.addEventListener("timeupdate",()=>{
    const cue=Array.from(track.activeCues||[])[0];
    if(cue && cue.text.trim()){
      const imgName=cue.text.trim();
      const imgURL=`https://${cdn}/${videoId}/${folder}/${imgName}`;
      subtitleOverlay.src=imgURL;
      subtitleOverlay.style.left=(video.clientWidth/2-(subtitleOverlay.width/2))+"px";
      subtitleOverlay.style.bottom=(video.clientHeight*0.08)+"px";
      subtitleOverlay.style.display="block";
      subtitleOverlay.style.opacity="1";
    } else {
      subtitleOverlay.style.opacity="0";
      subtitleOverlay.style.display="none";
    }
  });
}

// --- Movie Parser ---
async function fetchMovieById(movieId){ const query=`query getMovie($id:Int!){ movie(id:$id){ id titleTh titleEn video{ transcodeUuid cdnHostname subtitleMetadata } } }`;
  const response=await fetch("https://api.doo-nang.com/graphql",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({query,variables:{id:movieId}})});
  const result=await response.json(); const movie=result?.data?.movie; if(!movie) return null;
  const transcodeUuid=movie.video?.transcodeUuid, cdnHostname=movie.video?.cdnHostname; let videoUrl="",subtitle=[],audioTracks=[];
  if(transcodeUuid&&cdnHostname){ const base=`https://${cdnHostname}/${transcodeUuid}`; videoUrl=`https://api.doo-nang.com/video/${transcodeUuid}/playlist.m3u8`;
    if(movie.video?.subtitleMetadata){ for(const [lang,subs] of Object.entries(movie.video.subtitleMetadata)){ for(const sub of subs){ let src;
      if(sub.codec==="VTT") src=`${base}/${sub.pathName}.vtt`; else if(sub.codec==="BDN") src=`${base}/${sub.pathName}/index.xml`;
      if(await checkSubtitleExists(src)) subtitle.push({lang,codec:sub.codec,src,cdn:cdnHostname,videoId:transcodeUuid}); } } }
    try{ const res=await fetch(videoUrl); if(res.ok) audioTracks=extractAudioTracks(await res.text()); }catch{} }
  return { id:movie.id, title:movie.titleTh||movie.titleEn, video:videoUrl, subtitle, audioTracks }; }

// --- Series Parser ---
async function fetchSeriesById(showId){ const query=`query getShow($id:Int!){ show(id:$id){ id titleTh titleEn episodes{ seasonNo episodeNo titleTh titleEn video{ transcodeUuid cdnHostname subtitleMetadata } } } }`;
  const response=await fetch("https://api.doo-nang.com/graphql",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({query,variables:{id:showId}})});
  const result=await response.json(); return result?.data?.show||null; }
async function processEpisode(ep){ const transcodeUuid=ep.video?.transcodeUuid, cdnHostname=ep.video?.cdnHostname; let videoUrl="",subtitle=[],audioTracks=[];
  if(transcodeUuid&&cdnHostname){ const base=`https://${cdnHostname}/${transcodeUuid}`; videoUrl=`https://api.doo-nang.com/video/${transcodeUuid}/playlist.m3u8`;
    if(ep.video?.subtitleMetadata){ for(const [lang,subs] of Object.entries(ep.video.subtitleMetadata)){ for(const sub of subs){ let src;
      if(sub.codec==="VTT") src=`${base}/${sub.pathName}.vtt`; else if(sub.codec==="BDN") src=`${base}/${sub.pathName}/index.xml`;
      if(await checkSubtitleExists(src)) subtitle.push({lang,codec:sub.codec,src,cdn:cdnHostname,videoId:transcodeUuid}); } } }
    try{ const res=await fetch(videoUrl); if(res.ok) audioTracks=extractAudioTracks(await res.text()); }catch{} }
  return { season:ep.seasonNo, episode:ep.episodeNo, title:ep.titleTh||ep.titleEn||`EP${ep.episodeNo}`, video:videoUrl, subtitle, audioTracks }; }

</script>

<!-- Script Part 2: Player Init + Init Page -->
<script>
// --- Player Init ---
function initPlayer(videoURL){
  const video=document.getElementById("video");
  const audioSelector=document.getElementById("audioSelector");
  const qualitySelector=document.getElementById("qualitySelector");

  if(Hls.isSupported()){
    const hls=new Hls();
    hls.attachMedia(video);
    hls.loadSource(videoURL);

    hls.on(Hls.Events.MANIFEST_PARSED,()=>{
      // Audio menu
      audioSelector.innerHTML='';
      hls.audioTracks.forEach((track,i)=>{
        const opt=document.createElement("option");
        opt.value=i;
        opt.text=`${track.name||'Track'} (${track.lang||'und'})`;
        audioSelector.appendChild(opt);
      });
      audioSelector.onchange=()=>{ hls.audioTrack=parseInt(audioSelector.value); };

      // Quality menu
      qualitySelector.innerHTML='<option value="-1">Auto</option>';
      hls.levels.forEach((level,i)=>{
        const label=level.height?`${level.height}p`:`${Math.round(level.bitrate/1000)}kbps`;
        const opt=document.createElement("option");
        opt.value=i; opt.text=label;
        qualitySelector.appendChild(opt);
      });
      qualitySelector.onchange=()=>{ hls.currentLevel=parseInt(qualitySelector.value); };
    });
  } else if(video.canPlayType("application/vnd.apple.mpegurl")){
    video.src=videoURL;
  }
}

// --- Init Page ---
window.onload = async () => {
  const params = new URLSearchParams(window.location.search);
  const type = params.get("type");
  const ids = params.get("ids");

  if(type==="movie" && ids){
    const movie = await fetchMovieById(parseInt(ids,10));
    if(movie){
      initPlayer(movie.video);
      renderSubtitleMenu(movie.subtitle);
      document.getElementById("videoTitle").innerText = movie.title;
    } else {
      document.getElementById("videoTitle").innerText = "ไม่พบข้อมูลหนัง";
    }
  } else if(type==="series" && ids){
    const show = await fetchSeriesById(parseInt(ids,10));
    if(show){
      document.title = `${show.titleTh} (${show.titleEn})`;
      const seasonSelect=document.getElementById("seasonSelect");
      const episodeSelect=document.getElementById("episodeSelect");
      const selectorBar=document.getElementById("selectorBar");
      selectorBar.style.display="flex";

      const seasonMap={};
      show.episodes.forEach(ep=>{
        if(!seasonMap[ep.seasonNo]) seasonMap[ep.seasonNo]=[];
        seasonMap[ep.seasonNo].push(ep);
      });

      Object.keys(seasonMap).forEach(seasonNo=>{
        const opt=document.createElement("option");
        opt.value=seasonNo; opt.text=`Season ${seasonNo}`;
        seasonSelect.appendChild(opt);
      });

      async function loadEpisodes(seasonNo){
        episodeSelect.innerHTML="";
        seasonMap[seasonNo].forEach(ep=>{
          const opt=document.createElement("option");
          opt.value=ep.episodeNo;
          opt.text=`Episode ${ep.episodeNo} - ${ep.titleTh||ep.titleEn}`;
          episodeSelect.appendChild(opt);
        });

        // โหลดตอนแรกของ season ที่เลือก
        const firstEp = seasonMap[seasonNo][0];
        const epData = await processEpisode(firstEp);
        initPlayer(epData.video);
        renderSubtitleMenu(epData.subtitle);
        document.getElementById("videoTitle").innerText = epData.title;
      }

      // เมื่อเปลี่ยน season
      seasonSelect.addEventListener("change", ()=>loadEpisodes(seasonSelect.value));

      // เมื่อเปลี่ยน episode
      episodeSelect.addEventListener("change", async ()=>{
        const seasonNo = seasonSelect.value;
        const episodeNo = episodeSelect.value;
        const ep = seasonMap[seasonNo].find(e => String(e.episodeNo) === episodeNo);
        if(ep){
          const epData = await processEpisode(ep);
          initPlayer(epData.video);
          renderSubtitleMenu(epData.subtitle);
          document.getElementById("videoTitle").innerText = epData.title;
        }
      });

      // โหลด season แรกโดยอัตโนมัติ
      const firstSeason = Object.keys(seasonMap)[0];
      seasonSelect.value = firstSeason;
      await loadEpisodes(firstSeason);

    } else {
      document.getElementById("videoTitle").innerText = "ไม่พบข้อมูลซีรีส์";
    }
  }
};
</script>
</body>
</html>
