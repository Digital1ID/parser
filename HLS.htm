<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Custom HLS Player</title>
  <script src="https://cdn.jsdelivr.net/npm/hls.js@0.14.17"></script>
  <style>
    body { margin:0; background:#000; width:100vw; height:100vh; display:flex; flex-direction:column; }
    video { flex:1; width:100%; height:100%; object-fit:contain; }
    #subtitleOverlay {
      position: fixed; z-index: 9999; pointer-events: none;
      display: none; opacity: 0;
      transition: opacity 0.4s ease, transform 0.3s ease;
      max-width: 60%; max-height: 25%;
      left: 50%; bottom: 8%; transform: translateX(-50%);
      filter: drop-shadow(0 2px 4px rgba(0,0,0,0.7));
      border-radius: 6px; background-color: rgba(0,0,0,0.2);
    }
    #controls { background:#111; color:#fff; padding:10px; display:flex; gap:20px; justify-content:center; }
    select { padding:6px; background:rgba(255,255,255,0.1); border:1px solid rgba(255,255,255,0.3); color:#fff; border-radius:4px; }
    #videoTitle { color:#fff; padding:10px; text-align:center; }
    #selectorBar { background:#222; color:#fff; padding:10px; display:none; gap:20px; justify-content:center; }
  </style>
</head>
<body>
  <video id="video" autoplay controls crossorigin="anonymous"></video>
  <img id="subtitleOverlay" />
  <div id="controls">
    <label>Audio: <select id="audioSelector"></select></label>
    <label>Quality: <select id="qualitySelector"></select></label>
    <label>Subtitle: <select id="subtitleSelector"><option value="none">No Subtitles</option></select></label>
  </div>
  <div id="selectorBar">
    <label>Season: <select id="seasonSelect"></select></label>
    <label>Episode: <select id="episodeSelect"></select></label>
  </div>
  <div id="videoTitle"></div>

<script>
// --- Player setup ---
const video=document.getElementById("video");
const audioSelector=document.getElementById("audioSelector");
const qualitySelector=document.getElementById("qualitySelector");
const subtitleSelector=document.getElementById("subtitleSelector");
const seasonSelect=document.getElementById("seasonSelect");
const episodeSelect=document.getElementById("episodeSelect");
const selectorBar=document.getElementById("selectorBar");

// Netflix-style shortcuts
document.addEventListener("keydown",e=>{
  switch(e.key.toLowerCase()){
    case " ": e.preventDefault(); video.paused?video.play():video.pause(); break;
    case "arrowleft": video.currentTime=Math.max(0,video.currentTime-10); break;
    case "arrowright": video.currentTime=Math.min(video.duration,video.currentTime+10); break;
    case "f": !document.fullscreenElement?video.requestFullscreen():document.exitFullscreen(); break;
    case "m": video.muted=!video.muted; break;
  }
});

// --- Subtitle Handling ---
async function addVTTSubtitle(src, lang) {
  const track = document.createElement("track");
  track.kind = "subtitles";
  track.label = lang.toUpperCase();
  track.srclang = lang;
  track.src = src;
  video.appendChild(track);
}

async function addBDNSubtitle(baseUrl, videoId, cdn, lang) {
  const { folder } = await loadBDNAsVTT(baseUrl, videoId, cdn);
  activateBDNOverlay(folder, videoId, cdn);
  const opt = document.createElement("option");
  opt.value = lang;
  opt.text = lang.toUpperCase();
  subtitleSelector.appendChild(opt);
}

// เมื่อผู้ใช้เปลี่ยน subtitle
subtitleSelector.onchange = () => {
  const selected = subtitleSelector.value;
  Array.from(video.textTracks).forEach(track => track.mode = "disabled");
  subtitleOverlay.style.display = "none";
  subtitleOverlay.style.opacity = "0";

  if (selected === "none") return;

  const vttTrack = Array.from(video.textTracks).find(
    track => (track.language || track.srclang) === selected
  );
  if (vttTrack) {
    vttTrack.mode = "showing";
    return;
  }

  // ถ้าเป็น BDN → overlay
  const bdnEntry = bdnSubtitles.find(sub => sub.lang === selected);
  if (bdnEntry) {
    activateBDNOverlay(bdnEntry.folder, bdnEntry.videoId, bdnEntry.cdn);
  }
};

// GraphQL Parsers
async function fetchMovieById(movieId){
  const query=`query getMovie($id:Int!){ movie(id:$id){ id titleTh titleEn video{ transcodeUuid cdnHostname } } }`;
  const response=await fetch('https://api.doo-nang.com/graphql',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({query,variables:{id:movieId}})});
  const result=await response.json(); const movie=result?.data?.movie; if(!movie) return null;
  const transcodeUuid=movie.video?.transcodeUuid, cdnHostname=movie.video?.cdnHostname;
  if(transcodeUuid&&cdnHostname){ return { title:movie.titleTh||movie.titleEn, video:`https://api.doo-nang.com/video/${transcodeUuid}/playlist.m3u8` }; }
  return null;
}
async function fetchSeriesById(showId){
  const query=`query getShow($id:Int!){ show(id:$id){ id titleTh titleEn episodes{ seasonNo episodeNo titleTh titleEn video{ transcodeUuid cdnHostname } } } }`;
  const response=await fetch("https://api.doo-nang.com/graphql",{method:"POST",headers:{ "Content-Type":"application/json" },body:JSON.stringify({query,variables:{id:showId}})});
  const result=await response.json(); return result?.data?.show||null;
}

// Setup Player
function setupPlayer(videoUrl,title){
  document.getElementById("videoTitle").innerText=title;
  if(Hls.isSupported()){ const hls=new Hls(); hls.loadSource(videoUrl); hls.attachMedia(video);
    hls.on(Hls.Events.MANIFEST_PARSED,()=>{
      audioSelector.innerHTML=""; hls.audioTracks.forEach((track,i)=>{
        const opt=document.createElement("option"); opt.value=i; opt.text=track.name||track.lang||`Track ${i}`;
        audioSelector.appendChild(opt); }); audioSelector.onchange=()=>hls.audioTrack=parseInt(audioSelector.value);
      qualitySelector.innerHTML='<option value="-1">Auto</option>'; hls.levels.forEach((level,i)=>{
        const opt=document.createElement("option"); opt.value=i; opt.text=level.height?`${level.height}p`:`${Math.round(level.bitrate/1000)}kbps`;
        qualitySelector.appendChild(opt); }); qualitySelector.onchange=()=>hls.currentLevel=parseInt(qualitySelector.value);
    });
  } else if(video.canPlayType("application/vnd.apple.mpegurl")){ video.src=videoUrl; }
}

// Init
async function initPage(){
  const params=new URLSearchParams(window.location.search);
  const type=params.get("type"), ids=params.get("ids");
  if(!ids){ document.getElementById("videoTitle").innerText="ไม่พบ ID"; return; }

  if(type==="movie"){ const movie=await fetchMovieById(parseInt(ids,10)); if(movie) setupPlayer(movie.video,movie.title); }
  else if(type==="series"){ const show=await fetchSeriesById(parseInt(ids,10));
    if(!show){ document.getElementById("videoTitle").innerText="ไม่พบข้อมูลซีรีส์"; return; }
    document.title=`${show.titleTh} (${show.titleEn})`; selectorBar.style.display="flex";
    const seasonMap={}; show.episodes.forEach(ep=>{ if(!seasonMap[ep.seasonNo]) seasonMap[ep.seasonNo]=[]; seasonMap[ep.seasonNo].push(ep); });
    Object.keys(seasonMap).forEach(seasonNo=>{ const opt=document.createElement("option"); opt.value=seasonNo; opt.text=`Season ${seasonNo}`; seasonSelect.appendChild(opt); });
    async function loadEpisodes(seasonNo){ episodeSelect.innerHTML=""; seasonMap[seasonNo].forEach(ep=>{
        const opt=document.createElement("option"); opt.value=ep.episodeNo; opt.text=`Episode ${ep.episodeNo} - ${ep.titleTh||ep.titleEn}`; episodeSelect.appendChild(opt); });
      const firstEp=seasonMap[seasonNo][0]; const videoUrl=`https://api.doo-nang.com/video/${firstEp.video.transcodeUuid}/playlist.m3u8`;
      setupPlayer(videoUrl,firstEp.titleTh||firstEp.titleEn||`EP${firstEp.episodeNo}`); }
    seasonSelect.addEventListener("change",()=>loadEpisodes(seasonSelect.value));
    episodeSelect.addEventListener("change",()=>{ const seasonNo=seasonSelect.value; const ep=seasonMap[seasonNo].find(e=>String(e.episodeNo)===episodeSelect.value);
      if(ep){ const videoUrl=`https://api.doo-nang.com/video/${ep.video.transcodeUuid}/playlist.m3u8`; setupPlayer(videoUrl,ep.titleTh||ep.titleEn||`EP${ep.episodeNo}`); } });
    const firstSeason=Object.keys(seasonMap)[0]; seasonSelect.value=firstSeason; await loadEpisodes(firstSeason);
  }
}
window.onload=initPage;
</script>
</body>
</html>
