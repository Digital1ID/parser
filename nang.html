<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>Doo-Nang Movie Parser</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f9f9f9; padding: 20px; }
    pre { background: #222; color: #0f0; padding: 10px; overflow-x: auto; }
    button { padding: 8px 12px; margin: 5px; border: none; border-radius: 4px; background: #0078d7; color: #fff; cursor: pointer; }
  </style>
</head>
<body>
  <h1>Doo-Nang Movie Parser</h1>
  <input id="movieId" type="text" placeholder="กรอก Movie ID">
  <button id="fetchBtn">ดึงข้อมูล</button>
  <div id="output">รอรับข้อมูล...</div>

<script>
const nationMap = {
  TH: "ภาพยนตร์ ไทย", KR: "ภาพยนตร์ เกาหลี", JP: "ภาพยนตร์ ญี่ปุ่น", IN: "ภาพยนตร์ อินเดีย",
  US: "ภาพยนตร์ สหรัฐอเมริกา", CA: "ภาพยนตร์ แคนาดา", CN: "ภาพยนตร์ จีน", FR: "ภาพยนตร์ ฝรั่งเศส",
  GB: "ภาพยนตร์ อังกฤษ", MY: "ภาพยนตร์ มาเลเซีย", ES: "ภาพยนตร์ สเปน", PH: "ภาพยนตร์ ฟิลิปปินส์",
  IE: "ภาพยนตร์ ไอร์แลนด์", ID: "ภาพยนตร์ อินโดนีเซีย"
};

async function checkSubtitleExists(url) {
  try {
    const res = await fetch(url, { method: 'HEAD' });
    return res.ok;
  } catch {
    return false;
  }
}

// ฟังก์ชันตรวจหา audio track URI จาก playlist.m3u8
function extractAudioTracks(m3u8Text) {
  const audioTracks = [];
  const regex = /#EXT-X-MEDIA:TYPE=AUDIO.*?LANGUAGE="([^"]+)".*?URI="([^"]+)"/g;
  let match;
  while ((match = regex.exec(m3u8Text)) !== null) {
    audioTracks.push({ language: match[1], uri: match[2] });
  }
  return audioTracks;
}

async function fetchMovieById(movieId) {
  const query = `
    query getMovie($id: Int!) {
      movie(id: $id) {
        titleTh titleEn descriptionTh synopsisTh releaseDate posterUrl imdbRating slug nation
        genres { name slug }
        video { transcodeUuid cdnHostname }
      }
    }
  `;

  const response = await fetch('https://api.doo-nang.com/graphql', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ query, operationName: 'getMovie', variables: { id: movieId } })
  });

  const result = await response.json();
  const movie = result?.data?.movie;
  if (!movie) {
    return { error: "❌ ไม่พบข้อมูลภาพยนตร์ id=" + movieId };
  }

  const genres = movie.genres?.map(g => g.name) || [];
  const imdbRating = movie.imdbRating || '0.0';
  const plot = movie.descriptionTh?.trim() || movie.synopsisTh?.trim() || '-';
  const year = movie.releaseDate?.substring(0, 4) || '0000';
  const category = nationMap[movie.nation] || "ภาพยนตร์ ทั่วไป";

  const transcodeUuid = movie.video?.transcodeUuid;
  const cdnHostname = movie.video?.cdnHostname;
  const subtitle = [];
  let audioTracks = [];
  let videoUrl = "";

  if (transcodeUuid && cdnHostname) {
    const base = `https://${cdnHostname}/${transcodeUuid}`;
    videoUrl = `https://api.doo-nang.com/video/${transcodeUuid}/playlist.m3u8`;

    // ตรวจ subtitle
    const subtitleVariants = [
      { lang: "th", codec: "VTT", label: "Thai (VTT)", src: `${base}/sub_tha.vtt` },
      { lang: "th", codec: "BDN", label: "Thai (BDN)", src: `${base}/sub_tha/index.xml` }
    ];
    for (const sub of subtitleVariants) {
      if (await checkSubtitleExists(sub.src)) subtitle.push(sub);
    }

    // โหลด playlist.m3u8 เพื่อตรวจหา audio track
    try {
      const res = await fetch(videoUrl);
      if (res.ok) {
        const m3u8Text = await res.text();
        audioTracks = extractAudioTracks(m3u8Text);
      }
    } catch (e) {
      console.warn("ไม่สามารถโหลด playlist.m3u8 ได้", e);
    }
  }

  return {
    name: `${movie.titleEn || movie.titleTh} - ${movie.titleTh || movie.titleEn}`,
    category,
    info: {
      poster: movie.posterUrl,
      genre: genres,
      plot,
      rating: imdbRating,
      year
    },
    video: videoUrl,
    subtitle,
    audioTracks
  };
}

document.getElementById("fetchBtn").addEventListener("click", async () => {
  const id = parseInt(document.getElementById("movieId").value, 10);
  const output = document.getElementById("output");
  output.innerHTML = "⏳ กำลังโหลด...";
  const data = await fetchMovieById(id);
  output.innerHTML = `<pre>${JSON.stringify(data, null, 2)}</pre>`;
});
</script>
</body>
</html>

