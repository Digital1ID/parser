<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>Parser + JWPlayer</title>
  <style>
    body { margin:0; background:#000; width:100vw; height:100vh; display:flex; flex-direction:column; }
    #play { flex:1; }
    #selectorBar { background:#111; color:#fff; padding:10px; display:none; gap:20px; }
    select { padding:6px; }
    #videoTitle { color:#fff; padding:10px; }
    .subtitle-overlay {
      position: absolute;
      bottom: 50px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 9999;
    }
    .subtitle-overlay img {
      max-width:80%;
      border:2px solid #fff;
    }
  </style>
</head>
<body>
  <div id="selectorBar">
    <label for="seasonSelect">เลือกซีซั่น:</label>
    <select id="seasonSelect"></select>
    <label for="episodeSelect">เลือกตอน:</label>
    <select id="episodeSelect"></select>
  </div>
  <div id="play"></div>
  <div id="videoTitle"></div>

  <script src="https://digital1id.vercel.app/p2p/jw/jwplayer.js"></script>
<script>
jwplayer.key = "eNFaXCjyURVoCCGiHp7HTQ3hDhE/AfL0g8VE1fRbL84=";

// --- Utilities ---
async function checkSubtitleExists(url) {
  try { const res = await fetch(url, { method: 'HEAD' }); return res.ok; } catch { return false; }
}
function extractAudioTracks(m3u8Text) {
  const audioTracks = []; const regex = /#EXT-X-MEDIA:TYPE=AUDIO.*?LANGUAGE="([^"]+)".*?URI="([^"]+)"/g; let match;
  while ((match = regex.exec(m3u8Text)) !== null) audioTracks.push({ language: match[1], uri: match[2] });
  return audioTracks;
}

// --- BDN → VTT Converter ---
async function loadBDNAsVTT(baseUrl, lang) {
  try {
    const res = await fetch(`${baseUrl}/index.xml`);
    const xmlText = await res.text();
    const parser = new DOMParser();
    const xmlDoc = parser.parseFromString(xmlText, "application/xml");

    let vtt = "WEBVTT\n\n";
    const events = xmlDoc.querySelectorAll("Event");
    events.forEach((ev, i) => {
      const start = convertTimecode(ev.getAttribute("InTC"));
      const end = convertTimecode(ev.getAttribute("OutTC"));
      const img = ev.querySelector("Graphic")?.getAttribute("Source");
      if(start && end && img){
        vtt += `${i+1}\n${start} --> ${end}\n<img src="${baseUrl}/${img}">\n\n`;
      }
    });

    const blob = new Blob([vtt], { type: "text/vtt" });
    const url = URL.createObjectURL(blob);

    return { file: url, label: lang.toUpperCase()+" (BDN)", kind: "captions" };
  } catch (err) {
    console.error("BDN parse error:", err);
    return null;
  }
}

function convertTimecode(tc) {
  if(!tc) return null;
  const parts = tc.split(":");
  if(parts.length < 4) return null;
  const [hh, mm, ss, ff] = parts.map(Number);
  const ms = Math.floor((ff/25)*1000); // สมมติ 25fps
  return `${String(hh).padStart(2,"0")}:${String(mm).padStart(2,"0")}:${String(ss).padStart(2,"0")}.${String(ms).padStart(3,"0")}`;
}

// --- Movie Parser ---
async function fetchMovieById(movieId) {
  const query = `
    query getMovie($id: Int!) {
      movie(id: $id) {
        id titleTh titleEn
        video { transcodeUuid cdnHostname subtitleMetadata }
      }
    }
  `;
  const response = await fetch('https://api.doo-nang.com/graphql', {
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ query, variables:{ id: movieId } })
  });
  const result = await response.json();
  const movie = result?.data?.movie;
  if (!movie) return null;

  let videoUrl="", subtitle=[], audioTracks=[];
  const transcodeUuid=movie.video?.transcodeUuid, cdnHostname=movie.video?.cdnHostname;
  if(transcodeUuid && cdnHostname){
    const base=`https://${cdnHostname}/${transcodeUuid}`;
    videoUrl=`https://api.doo-nang.com/video/${transcodeUuid}/playlist.m3u8`;
    const subs=[
      {lang:"th",codec:"VTT",src:`${base}/sub_tha.vtt`},
      {lang:"en",codec:"VTT",src:`${base}/sub_eng.vtt`},
      {lang:"th",codec:"BDN",src:`${base}/sub_tha`}
    ];
    for(const s of subs) if(await checkSubtitleExists(s.src+(s.codec==="BDN"?"/index.xml":""))) subtitle.push(s);
    try{const res=await fetch(videoUrl); if(res.ok) audioTracks=extractAudioTracks(await res.text());}catch{}
  }

  return { id:movie.id, title:movie.titleTh||movie.titleEn, video:videoUrl, subtitle, audioTracks };
}

// --- Series Parser ---
async function fetchSeriesById(showId) {
  const query = `
    query getShow($id: Int!) {
      show(id: $id) {
        id titleTh titleEn
        episodes {
          seasonNo episodeNo titleTh titleEn
          video { transcodeUuid cdnHostname subtitleMetadata }
        }
      }
    }
  `;
  const response = await fetch("https://api.doo-nang.com/graphql", {
    method:"POST", headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({ query, variables:{ id: showId } })
  });
  const result = await response.json();
  return result?.data?.show || null;
}

async function processEpisode(ep) {
  const transcodeUuid=ep.video?.transcodeUuid, cdnHostname=ep.video?.cdnHostname;
  let videoUrl="", subtitle=[], audioTracks=[];
  if(transcodeUuid && cdnHostname){
    const base=`https://${cdnHostname}/${transcodeUuid}`;
    videoUrl=`https://api.doo-nang.com/video/${transcodeUuid}/playlist.m3u8`;
    if(ep.video?.subtitleMetadata){
      for(const [lang,subs] of Object.entries(ep.video.subtitleMetadata)){
        for(const sub of subs){
          const src=`${base}/${sub.pathName}.vtt`;
          if(await checkSubtitleExists(src+(sub.codec==="BDN"?"/index.xml":`.${sub.codec.toLowerCase()}`))) subtitle.push({lang,codec:sub.codec,src});
        }
      }
    }
    try{const res=await fetch(videoUrl); if(res.ok) audioTracks=extractAudioTracks(await res.text());}catch{}
  }
  return { season:ep.seasonNo, episode:ep.episodeNo, title:ep.titleTh||ep.titleEn||`EP${ep.episodeNo}`, video:videoUrl, subtitle, audioTracks };
}

// --- Setup JWPlayer ---
async function setupPlayer(data){
  document.getElementById("videoTitle").innerText=data.title;
  const playerConfig={ width:"100%", height:"100%", aspectratio:"16:9", playlist:[{ file:data.video, tracks:[] }], primary:"html5", hlshtml:true, controls:true, autostart:true };
  
  document.querySelectorAll(".subtitle-overlay").forEach(el=>el.remove());

  for(const sub of data.subtitle){
    if(sub.codec==="VTT"){
      playerConfig.playlist[0].tracks.push({ file: sub.src, label: sub.lang.toUpperCase(), kind: "captions" });
    } else if(sub.codec==="BDN"){
      const track = await loadBDNAsVTT(sub.src, sub.lang);
      if(track) playerConfig.playlist[0].tracks.push(track);
    }
  }

  data.audioTracks.forEach(at=>{
    playerConfig.playlist[0].tracks.push({ file: at.uri, label: at.language.toUpperCase()+" Audio", kind: "audio" });
  });

  jwplayer("play").setup(playerConfig);
}

// --- Init ---
async function initPage(){
  const params=new URLSearchParams(window.location.search);
  const type=params.get("type"), ids=params.get("ids");
  if(!ids){ document.getElementById("videoTitle").innerText="ไม่พบ ID"; return; }

  if(type==="movie"){
    const movie=await fetchMovieById(parseInt(ids,10));
    if(movie) setupPlayer(movie);
    } else if(type==="series"){
    const show=await fetchSeriesById(parseInt(ids,10));
    if(!show){ document.getElementById("videoTitle").innerText="ไม่พบข้อมูลซีรีส์"; return; }

    document.title=`${show.titleTh} (${show.titleEn})`;
    const seasonSelect=document.getElementById("seasonSelect");
    const episodeSelect=document.getElementById("episodeSelect");
    const selectorBar=document.getElementById("selectorBar");
    selectorBar.style.display="flex";

    const seasonMap={};
    show.episodes.forEach(ep=>{
      if(!seasonMap[ep.seasonNo]) seasonMap[ep.seasonNo]=[];
      seasonMap[ep.seasonNo].push(ep);
    });

    Object.keys(seasonMap).forEach(seasonNo=>{
      const opt=document.createElement("option");
      opt.value=seasonNo; opt.text=`Season ${seasonNo}`;
      seasonSelect.appendChild(opt);
    });

    async function loadEpisodes(seasonNo){
      episodeSelect.innerHTML="";
      seasonMap[seasonNo].forEach(ep=>{
        const opt=document.createElement("option");
        opt.value=ep.episodeNo; opt.text=`Episode ${ep.episodeNo} - ${ep.titleTh||ep.titleEn}`;
        episodeSelect.appendChild(opt);
      });
      const firstEp=seasonMap[seasonNo][0];
      const epData=await processEpisode(firstEp);
      setupPlayer(epData);
    }

    seasonSelect.addEventListener("change", ()=>loadEpisodes(seasonSelect.value));

    episodeSelect.addEventListener("change", async ()=>{
      const seasonNo = seasonSelect.value;
      const episodeNo = episodeSelect.value;
      const ep = seasonMap[seasonNo].find(e => String(e.episodeNo) === episodeNo);
      if(ep){
        const epData = await processEpisode(ep);
        setupPlayer(epData);
      }
    });

    // โหลดซีซั่นแรกและตอนแรกโดยอัตโนมัติ
    const firstSeason = Object.keys(seasonMap)[0];
    seasonSelect.value = firstSeason;
    await loadEpisodes(firstSeason);
  }
}

window.onload = initPage;
</script>
</body>
</html>
