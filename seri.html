<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>Doo-Nang Series Parser</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f9f9f9; padding: 20px; }
    pre { background: #222; color: #0f0; padding: 10px; overflow-x: auto; }
    button { padding: 8px 12px; margin: 5px; border: none; border-radius: 4px; background: #0078d7; color: #fff; cursor: pointer; }
  </style>
</head>
<body>
  <h1>Doo-Nang Series Parser</h1>
  <input id="showId" type="text" placeholder="กรอก Show ID">
  <button id="fetchBtn">ดึงข้อมูลซีรีส์</button>
  <div id="output">รอรับข้อมูล...</div>

<script>
async function checkSubtitleExists(url) {
  try {
    const res = await fetch(url, { method: 'HEAD' });
    return res.ok;
  } catch {
    return false;
  }
}

// ฟังก์ชันตรวจหา audio track URI จาก playlist.m3u8
function extractAudioTracks(m3u8Text) {
  const audioTracks = [];
  const regex = /#EXT-X-MEDIA:TYPE=AUDIO.*?LANGUAGE="([^"]+)".*?URI="([^"]+)"/g;
  let match;
  while ((match = regex.exec(m3u8Text)) !== null) {
    audioTracks.push({ language: match[1], uri: match[2] });
  }
  return audioTracks;
}

async function fetchSeriesById(showId) {
  const query = `
    query getShow($id: Int!) {
      show(id: $id) {
        titleTh titleEn slug
        seasons {
          seasonNo
          episodes {
            episodeNo titleTh titleEn
            video { transcodeUuid cdnHostname subtitleMetadata }
          }
        }
      }
    }
  `;

  const response = await fetch("https://api.doo-nang.com/graphql", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ query, variables: { id: showId } })
  });

  const result = await response.json();
  const show = result?.data?.show;
  if (!show) {
    return { error: "❌ ไม่พบข้อมูลซีรีส์ id=" + showId };
  }

  const seriesData = {
    name: `${show.titleTh} (${show.titleEn})`,
    slug: show.slug,
    seasons: []
  };

  for (const season of show.seasons || []) {
    const seasonData = {
      seasonNo: season.seasonNo,
      episodes: []
    };

    for (const ep of season.episodes || []) {
      const transcodeUuid = ep.video?.transcodeUuid;
      const cdnHostname = ep.video?.cdnHostname;
      let videoUrl = "";
      let subtitle = [];
      let audioTracks = [];

      if (transcodeUuid && cdnHostname) {
        const base = `https://${cdnHostname}/${transcodeUuid}`;
        videoUrl = `https://api.doo-nang.com/video/${transcodeUuid}/playlist.m3u8`;

        // ตรวจ subtitle จาก metadata
        if (ep.video?.subtitleMetadata) {
          for (const [lang, subs] of Object.entries(ep.video.subtitleMetadata)) {
            for (const sub of subs) {
              const src = `${base}/${sub.pathName}.${sub.codec.toLowerCase()}`;
              if (await checkSubtitleExists(src)) {
                subtitle.push({ lang, codec: sub.codec, src });
              }
            }
          }
        }

        // โหลด playlist.m3u8 เพื่อตรวจหา audio track
        try {
          const res = await fetch(videoUrl);
          if (res.ok) {
            const m3u8Text = await res.text();
            audioTracks = extractAudioTracks(m3u8Text);
          }
        } catch (e) {
          console.warn("ไม่สามารถโหลด playlist.m3u8 ได้", e);
        }
      }

      seasonData.episodes.push({
        episodeNo: ep.episodeNo,
        title: ep.titleTh || ep.titleEn || `EP${ep.episodeNo}`,
        video: videoUrl,
        subtitle,
        audioTracks
      });
    }

    seriesData.seasons.push(seasonData);
  }

  return seriesData;
}

document.getElementById("fetchBtn").addEventListener("click", async () => {
  const id = parseInt(document.getElementById("showId").value, 10);
  const output = document.getElementById("output");
  output.innerHTML = "⏳ กำลังโหลด...";
  const data = await fetchSeriesById(id);
  output.innerHTML = `<pre>${JSON.stringify(data, null, 2)}</pre>`;
});
</script>
</body>
</html>
