<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>Kub24HD Playlist Parser</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f9f9f9; padding: 20px; }
    pre { background: #222; color: #0f0; padding: 10px; overflow-x: auto; }
    .series { margin-bottom: 30px; }
    .poster { max-width: 200px; }
    .controls { margin: 15px 0; }
    button { margin-right: 10px; padding: 8px 12px; border: none; border-radius: 4px; cursor: pointer; }
    button.main { background: #0078d7; color: #fff; }
    button.backup { background: #444; color: #fff; }
  </style>
</head>
<body>
  <h1>Kub24HD Playlist Parser (HTML/JS Version)</h1>
  <div class="controls">
    <button class="main" onclick="main('main')">เฉพาะตัวเล่นหลัก</button>
    <button class="backup" onclick="main('backup')">เฉพาะตัวเล่นสำรอง</button>
  </div>
  <div id="output">Loading...</div>

<script>
async function fetchViaProxy(url) {
  const proxyUrl = `/api/proxy?url=${encodeURIComponent(url)}`;
  const res = await fetch(proxyUrl);
  if (!res.ok) return null;
  return await res.text();
}

async function fetchJsonViaProxy(url) {
  const proxyUrl = `/api/proxy?url=${encodeURIComponent(url)}`;
  const res = await fetch(proxyUrl);
  if (!res.ok) return null;
  return await res.json();
}

// ดึง player iframe จาก API
async function getPlayer(postId, mode = "main") {
  const apiUrl = `https://kub24hd.com/wp-admin/admin-ajax.php?action=mix_get_player&post_id=${postId}`;
  const json = await fetchJsonViaProxy(apiUrl);
  if (!json?.success) return [];

  const doc = new DOMParser().parseFromString(json.player, "text/html");
  const iframes = doc.querySelectorAll("iframe");
  const buttons = doc.querySelectorAll("button[data-src]");
  let sources = [];

  if (mode === "main") {
    // เอาเฉพาะตัวเล่นหลัก (iframe ตัวแรก)
    if (iframes.length > 0) sources.push(iframes[0].src);
  } else if (mode === "backup") {
    // เอาเฉพาะตัวเล่นสำรอง (ปุ่ม data-src ที่ไม่ใช่ตัวแรก)
    buttons.forEach(btn => {
      const src = btn.getAttribute("data-src");
      if (src && !src.includes("hdplayfull")) { // กรองตัวหลักออก
        sources.push(src);
      }
    });
  }

  return sources;
}

// แปลง iframe embed → .m3u8
function convertEmbedToM3U8(embedUrl) {
  try {
    const url = new URL(embedUrl);
    const videoId = url.pathname.split("/").pop();
    return `https://media.vdohls.com/${videoId}/playlist.m3u8`;
  } catch {
    return null;
  }
}

// สร้าง playlist .m3u
function generateM3U(seriesData) {
  let m3u = "#EXTM3U\n";
  const logo = seriesData.poster?.src || "";
  const title = seriesData.title || "ซีรีส์";
  let epNum = 1;
  for (const ep of seriesData.episodes) {
    for (const link of ep.m3u8List) {
      if (link) {
        m3u += `#EXTINF:-1 tvg-logo="${logo}" , ${title} EP${String(epNum).padStart(2,"0")}\n`;
        m3u += link + "\n";
      }
    }
    epNum++;
  }
  return m3u;
}

async function main(mode = "main") {
  const seriesUrl = "https://kub24hd.com/series/backstreet-rookie-2020/";
  const output = document.getElementById("output");
  output.innerHTML = "Loading...";

  const html = await fetchViaProxy(seriesUrl);
  if (!html) {
    output.innerHTML = `<p>โหลดข้อมูลไม่สำเร็จ</p>`;
    return;
  }

  const doc = new DOMParser().parseFromString(html, "text/html");
  const title = doc.querySelector("h1")?.textContent.trim() || "";
  const img = doc.querySelector("img.wp-post-image");
  const poster = img ? { src: img.getAttribute("data-src") || img.src, alt: img.alt } : {};
  const synopsis = doc.querySelector("p")?.textContent.trim() || "";

  // ดึง episode IDs
  const epButtons = doc.querySelectorAll("#eplist button.ep");
  let episodes = [];
  for (const btn of epButtons) {
    const postId = btn.id;
    const epTitle = btn.textContent.trim();
    const sources = await getPlayer(postId, mode);
    const m3u8List = sources.map(src => convertEmbedToM3U8(src)).filter(Boolean);
    episodes.push({ epTitle, m3u8List });
  }

  const seriesData = { poster, title, synopsis, episodes };
  const m3u = generateM3U(seriesData);

  output.innerHTML = `
    <div class="series">
      <h2>${title}</h2>
      <img class="poster" src="${poster.src}" alt="${poster.alt}">
      <p>${synopsis}</p>
      <h3>Playlist (.m3u)</h3>
      <pre>${m3u}</pre>
    </div>
  `;
}

// โหลดครั้งแรกเป็นเฉพาะตัวเล่นหลัก
main("main");
</script>
</body>
</html>
